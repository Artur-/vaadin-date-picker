<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <link rel="import" href="../vaadin-date-picker.html">
  <script src="common.js"></script>
  <script>
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'vaadin-date-picker-wrapper'
      });
    });
  </script>
</head>

<body>

  <test-fixture id="datepicker">
    <template>
      <vaadin-date-picker style="position: fixed;"></vaadin-date-picker>
    </template>
  </test-fixture>

  <test-fixture id="datepicker-wrapped">
    <template>
      <vaadin-date-picker-wrapper></vaadin-date-picker-wrapper>
    </template>
  </test-fixture>

  <dom-module id="vaadin-date-picker-wrapper">
    <template>
      <vaadin-date-picker id="datepicker" label="foo"></vaadin-date-picker>
    </template>
  </dom-module>

  <script>
    describe('Dropdown', () => {

      if(ios) return;

      var datepicker;
      var dropdown;

      beforeEach(() => {
        datepicker = fixture('datepicker');
        dropdown = datepicker.$.dropdown;
      });

      afterEach(done => setTimeout(done, 1));

      it('should set body `pointer-events: none` on open and restore initial value on close', done => {
        document.body.style.pointerEvents = 'painted';

        open(datepicker, () => {
          expect(getComputedStyle(document.body).pointerEvents).to.be.equal('none');
          expect(getComputedStyle(datepicker).pointerEvents).to.be.equal('auto');

          close(datepicker, () => {
            expect(getComputedStyle(document.body).pointerEvents).to.be.equal('painted');
            done();
          });
        });
      });

      it('should not close on calendar icon down', done => {
        open(datepicker, () => {
          MockInteractions.down(datepicker.$.calendar);
          expect(datepicker.$.dropdown.opened).to.be.true;
          done();
        });
      });

      if (document.createElement('div').style.webkitOverflowScrolling === '') {
        it('should handle webkit-overflow-scrolling', done => {
          document.body.style.webkitOverflowScrolling = 'touch';

          open(datepicker, () => {
            expect(window.getComputedStyle(document.body).webkitOverflowScrolling).to.equal('auto');

            close(datepicker, () => {
              expect(window.getComputedStyle(document.body).webkitOverflowScrolling).to.equal('touch');
              done();
            });
          });
        });
      }

      describe('Sizing', () => {
        if (ios) {
          return;
        }

        beforeEach(() => {
          var viewport = document.createElement('meta');
          viewport.setAttribute('name', 'viewport');
          viewport.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0');
          document.getElementsByTagName('head')[0].appendChild(viewport);

          datepicker._fullscreenMediaQuery = 'max-width: 520px';
        });

        it('should select fullscreen/desktop mode', done => {
          open(datepicker, () => {
            var viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            var fullscreen = viewportWidth < 520;

            expect(isFullscreen(datepicker)).to.equal(fullscreen);
            expect(dropdown.style.marginTop).to.equal((fullscreen ? 0 : datepicker.clientHeight + 2) + 'px');
            expect(dropdown.positionTarget).to.equal(fullscreen ? document.documentElement : datepicker);
            done();
          });
        });

      });

      describe('Alignment', () => {
        if (ios) {
          return;
        }

        beforeEach(() => document.body.style.padding = '500px');

        it('should align top/left', done => {
          datepicker.style.left = '0';
          datepicker.style.top = '0';
          open(datepicker, () => {
            expect(dropdown.verticalAlign).to.equal('top');
            expect(dropdown.horizontalAlign).to.equal('left');
            done();
          });
        });

        it('should align borrom/right', done => {
          datepicker.style.right = '0';
          datepicker.style.bottom = '0';
          open(datepicker, () => {
            expect(datepicker.$.dropdown.verticalAlign).to.equal('bottom');
            expect(datepicker.$.dropdown.horizontalAlign).to.equal('right');
            done();
          });
        });

      });
    });

    describe('Dropdown-wrapped', () => {
      if (ios) {
        return;
      }

      var datepicker;

      beforeEach(() => datepicker = fixture('datepicker-wrapped').$.datepicker);

      afterEach(done => {
        setTimeout(done, 1);
      });

      it('should not close on calendar icon down', done => {
        open(datepicker, () => {
          MockInteractions.down(datepicker.$.calendar);
          expect(datepicker.$.dropdown.opened).to.be.true;
          done();
        });
      });

    });
  </script>

</body>

</html>
